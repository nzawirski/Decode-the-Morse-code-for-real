import MORSE_CODE from "./morse.js";
const decodeMorse = function (morseCode) {
    return morseCode.split(' ').map(e => e === '' ? ' ' : MORSE_CODE[e]).join('').replace(/\s\s/g, ' ').trim()
}
const decodeBitsAdvanced = function (bits) {
    console.log(bits)
    bits = bits.replace(/^0+/g, '').replace(/0+$/g, '')
    if (!bits) {
        return ''
    }
    // count lengths of each part
    let zeroLengths = []
    let oneLengths = []
    bits.split(/1+/g).forEach(bit => {
        if (bit.length > 0) {
            zeroLengths.push(bit.length)
        }
    })
    bits.split(/0+/g).forEach(bit => {
        if (bit.length > 0) {
            oneLengths.push(bit.length)
        }
    })
    // sort lengths and remove duplicates
    zeroLengths = zeroLengths.sort((a, b) => a - b);
    oneLengths = oneLengths.sort((a, b) => a - b);
    const distinctZeroLengths = [...new Set(zeroLengths)]
    const distinctOneLengths = [...new Set(oneLengths)]

    // thresholds that will be used to detect symbols
    const dotPause = {
        min: distinctZeroLengths[0],
        max: 0
    }
    const dashPause = {
        min: 0,
        max: 0
    }
    const space = {
        min: 0,
        max: distinctZeroLengths[distinctZeroLengths.length - 1]
    }
    const dot = {
        min: distinctOneLengths[0],
        max: 0
    }
    const dash = {
        min: 0,
        max: distinctOneLengths[distinctOneLengths.length - 1],
    }

    // arbitrarily divide chunks into set of thresholds - for pauses
    const dotPauseThreshold = 0.22
    const dashPauseThreshold = 0.64
    const zerosDiff = (distinctZeroLengths[distinctZeroLengths.length - 1] - distinctZeroLengths[0])
    distinctZeroLengths.forEach(e => {
        if (e <= distinctZeroLengths[0] + zerosDiff * dotPauseThreshold) {
            dotPause.max = e;
            dashPause.min = e + 1
        }
        if (e <= distinctZeroLengths[0] + zerosDiff * dashPauseThreshold) {
            dashPause.max = e;
            space.min = e + 1
        }
    })
    // make sure maxima are not smaller than minima
    if (dashPause.min > dashPause.max) {
        dashPause.min = dashPause.max
    }
    if (space.min > space.max) {
        space.min = space.max
    }

    // arbitrarily divide chunks into set of thresholds - for ones
    const dotThreshold = 0.44
    const onesDiff = (distinctOneLengths[distinctOneLengths.length - 1] - distinctOneLengths[0])
    distinctOneLengths.every(e => {
        if (e <= distinctOneLengths[0] + onesDiff * dotThreshold) {
            dot.max = e;
            dash.min = e + 1
            return true
        }
        return false
    })
    // make sure maxima are not smaller than minima
    if (dash.min > dash.max) {
        dash.min = dash.max
    }

    // see what we just did
    console.log(distinctZeroLengths, distinctOneLengths)
    console.log('dash', dash)
    console.log('dot', dot)
    console.log('space', space)
    console.log('dashPause', dashPause)
    console.log('dotPause', dotPause)

    //replace strings of ones and zeros with detected symbols or pauses using regex
    let result = bits
    //dashes
    // if unsure if dot or dash we assume dot, so skipping in that case
    // unless spaces length suggests otherwise
    if(dash.min !== dot.max || (dashPause.max && dash.min > dashPause.max * 2)){
        const dashRegEx = new RegExp(`1{${dash.min},${dash.max}}`, 'g');
        result = result.replace(dashRegEx, '-')
    }
    //dots
    const dotRegEx = new RegExp(`1{${dot.min},${dot.max}}`, 'g');
    result = result.replace(dotRegEx, '.')

    //spaces between words
    // uhh im not sure why im checking for this
    if(space.min !== dashPause.max || (dot.max && space.min > dot.max * 4)){
        const spaceRegEx = new RegExp(`0{${space.min},${space.max}}`, 'g');
        result = result.replace(spaceRegEx, '   ')
    }

    //spaces between letters
    // more arbitrary bullshit checks
    if(dashPause.min !== dotPause.max || (dot.max && dashPause.min > dot.max * 1.5)){
        const dashPauseRegEx = new RegExp(`0{${dashPause.min},${dashPause.max}}`, 'g');
        result = result.replace(dashPauseRegEx, ' ')
    }

    //spaces between parts
    const dotPauseRegEx = new RegExp(`0{${dotPause.min},${dotPause.max}}`, 'g');
    result = result.replace(dotPauseRegEx, '')

    return result;
}

const msg = '00000000000000011111111000000011111111111100000000000111111111000001111111110100000000111111111111011000011111111011111111111000000000000000000011111111110000110001111111111111000111000000000001111111111110000111111111100001100111111111110000000000111111111111011100001110000000000000000001111111111010111111110110000000000000001111111111100001111111111110000100001111111111111100000000000111111111000000011000000111000000000000000000000000000011110001111100000111100000000111111111100111111111100111111111111100000000011110011111011111110000000000000000000000111111111110000000011111000000011111000000001111111111110000000001111100011111111000000000111111111110000011000000000111110000000111000000000011111111111111000111001111111111001111110000000000000000000001111000111111111100001111111111111100100000000001111111100111111110111111110000000011101111111000111000000001001111111000000001111111111000000000111100001111111000000000000011111111100111111110111111111100000000000111111110000001100000000000000000000111111101010000010000001111111100000000011111000111111111000000111111111110011111111001111111110000000011000111111110000111011111111111100001111100001111111100000000000011110011101110001000111111110000000001111000011111110010110001111111111000000000000000000111111111110000000100000000000000000011110111110000001000011101110000000000011111111100000011111111111100111111111111000111111111000001111111100000000000001110111111111111000000110011111111111101110001111111111100000000111100000111100000111111111100000111111111111000000011111111000000000001000000111100000001000001111100111111111110000000000000000000010001111111100000011111111100000000000000100001111111111110111001111111111100000111111100001111111111000000000000000000000000011100000111111111111011110000000010000000011111111100011111111111100001110000111111111111100000000000000111110000011111001111111100000000000011100011100000000000011111000001111111111101000000001110000000000000000000000000000111110010000000000111111111000011111111110000000000111111111111101111111111100000000010000000000000011111111100100001100000000000000111100111100000000001100000001111111111110000000011111111111000000000111100000000000000000000111101111111111111000000000001111000011111000011110000000001100111111100111000000000100111000000000000111110000010000011111000000000000001111111111100000000110111111111100000000000000111111111111100000111000000000111111110001111000000111111110111111000000001111000000000010000111111111000011110001111111110111110000111111111111000000000000000000000000111111111110000000111011111111100011111110000000001111111110000011111111100111111110000000001111111111100111111111110000000000110000000000000000001000011111111110000000001111111110000000000000000000000011111111111111000000111111111000001111111110000000000111111110000010000000011111111000011111001111111100000001110000000011110000000001011111111000011111011111111110011011111111111000000000000000000100011111111111101111111100000000000000001100000000000000000011110010111110000000011111111100000000001111100011111111111101100000000111110000011110000111111111111000000001111111111100001110111111111110111000000000011111111101111100011111111110000000000000000000000000010000111111111100000000001111111110111110000000000000000000000110000011110000000000001111111111100110001111111100000011100000000000111110000000011111111110000011111000001111000110000000011100000000000000111100001111111111100000111000000001111111111000000111111111100110000000001111000001111111100011100001111111110000010011111111110000000000000000000111100000011111000001111000000000111111001110000000011111111000100000000000011111111000011001111111100000000000110111000000000000111111111111000100000000111111111110000001111111111011100000000000000000000000000'
// const msg = '1001'
const decoded = decodeBitsAdvanced(msg);

console.log(decoded)
console.log(decodeMorse(decoded))